<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Publikationsorte Karte mit Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 90vh; width: 100vw; }
    #filter {
      padding: 10px;
      background: white;
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="filter">
    <label for="yearFilter">Filter nach Jahr:</label>
    <select id="yearFilter">
      <option value="all">Alle Jahre</option>
    </select>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Erstelle die Karte und setze den Startpunkt
    const map = L.map('map').setView([60, 10], 4); // Zentrale Position in Nordeuropa
    // OpenStreetMap als Grundkarte
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18
    }).addTo(map);
    // Erstelle eine Marker-Cluster-Gruppe
    const markers = L.markerClusterGroup();
    const allMarkers = []; // Array, um alle Marker zu speichern
    // Funktion zur Geokodierung (Umwandlung von Ortsnamen in Koordinaten)
    async function geocodeLocation(location) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${location}&format=json`);
      const data = await response.json();
      if (data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        console.error(`Ort nicht gefunden: ${location}`);
        return null; // Ort nicht gefunden
      }
    }
    // Funktion zum Verarbeiten der CSV-Daten
    async function processCSVData(data) {
      const years = new Set(); // Set, um einzigartige Jahre zu speichern
      for (const row of data) {
        const name = row["Name"];
        const publisher = row["Publisher"];
        const year = row["Year of Publication"];
        const place = row["Place of Publication"];
        const link = row["Permalink"];
        // Geokodierung des Orts
        const coords = await geocodeLocation(place);
        if (coords) {
          // Füge einen Marker hinzu, wenn Koordinaten gefunden wurden
          const marker = L.marker(coords);
          marker.bindPopup(`
            <strong>${name}</strong><br>
            <em>Publisher:</em> ${publisher}<br>
            <em>Year:</em> ${year}<br>
            <em>Place:</em> ${place}<br>
            <a href="${link}" target="_blank">Permalink</a>
          `);
          marker.year = year; // Speichere das Jahr als Eigenschaft des Markers
          markers.addLayer(marker); // Füge den Marker zur Cluster-Gruppe hinzu
          allMarkers.push(marker); // Speichere den Marker in der Liste
          // Füge das Jahr zur Dropdown-Liste hinzu
          years.add(year);
        } else {
          console.error(`Ort nicht gefunden: ${place}`);
        }
      }
      // Füge die Marker-Cluster-Gruppe zur Karte hinzu
      map.addLayer(markers);
      // Füge die Jahre zur Dropdown-Liste hinzu
      const yearFilter = document.getElementById("yearFilter");
      Array.from(years).sort().forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      });
      // Event-Listener für die Dropdown-Liste
      yearFilter.addEventListener("change", function () {
        const selectedYear = this.value;
        markers.clearLayers(); // Entferne alle Marker aus der Karte
        if (selectedYear === "all") {
          // Zeige alle Marker
          allMarkers.forEach(marker => markers.addLayer(marker));
        } else {
          // Zeige nur Marker für das ausgewählte Jahr
          allMarkers
            .filter(marker => marker.year === selectedYear)
            .forEach(marker => markers.addLayer(marker));
        }
      });
    }
    // CSV-Datei einlesen und verarbeiten
    Papa.parse('Liste_Kartensammlung.csv', {
      download: true,
      header: true,
      complete: function(results) {
        processCSVData(results.data);
      },
      error: function(error) {
        console.error("Fehler beim Einlesen der CSV-Datei:", error);
      }
    });
  </script>
</body>
</html>
